<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>学校管理システム</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <script>
document.addEventListener("DOMContentLoaded", () => {
  // header を読み込む
  loadHTML("/templates/base/header.html", "#header-container");

  // main.html を読み込む → 読み込み完了後にボタン処理を登録
  loadHTML("/templates/main/main.html", "#main-container", setupMainEvents);
});

// ===== メインイベント設定 =====
function setupMainEvents() {
  setupDropdowns();

  // 学生情報を登録する
  const registerBtn = document.getElementById("btn-student-register");
  if (registerBtn) {
    registerBtn.addEventListener("click", () => {
      loadMainPage("/templates/main/student_register.html");
    });
  }
  
  const updateBtn = document.getElementById("btn-student-update");
  if (updateBtn) {
    updateBtn.addEventListener("click", () => {
    // 学生情報検索画面へ遷移
      loadMainPage("/templates/main/student_search.html"); 
    });
  }

  // 未実装のボタンたち
  const passBtn = document.getElementById("btn-pass-create");
  const attendBtn = document.getElementById("btn-attendance-check");
  const certBtn = document.getElementById("btn-certificate-approve");

  [passBtn, attendBtn, certBtn].forEach(btn => {
    if (btn) {
      btn.addEventListener("click", () => {
        alert("この機能は現在準備中です。");
      });
    }
  });
}

function loadHTML(url, selector, callback) {
  fetch(url)
    .then(response => {
      if (!response.ok) throw new Error("読み込み失敗: " + url);
      return response.text();
    })
    .then(data => {
      const container = document.querySelector(selector);
      container.innerHTML = data;

      // ページ内 <script> を再実行
      container.querySelectorAll("script").forEach(oldScript => {
        const newScript = document.createElement("script");
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        document.body.appendChild(newScript);
      });

      if (callback) callback(); // ✅ main.html 読み込み完了後にイベント登録
    })
    .catch(error => {
      document.querySelector(selector).innerHTML =
        `<p style="color:red">${error}</p>`;
      console.error(error);
    });
}

function setupDropdowns() {
  const dropdownButtons = document.querySelectorAll('.dropbtn');

  dropdownButtons.forEach(button => {
    button.addEventListener('click', function () {
      const dropdown = this.parentElement;
      const isOpen = dropdown.classList.contains('open');
      document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
      if (!isOpen) dropdown.classList.add('open');
    });
  });

  document.addEventListener('click', function (event) {
    if (!event.target.closest('.dropdown')) {
      document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
    }
  });
}

function loadMainPage(url) {
  fetch(url)
    .then(response => {
      if (!response.ok) throw new Error("ページ読み込み失敗: " + url);
      return response.text();
    })
    .then(data => {
      const container = document.querySelector("#main-container");
      container.innerHTML = data;

      // ページ内スクリプトを再実行
      container.querySelectorAll("script").forEach(oldScript => {
        const newScript = document.createElement("script");
        newScript.textContent = oldScript.textContent;
        document.body.appendChild(newScript);
      });
    })
    .catch(error => {
      document.querySelector("#main-container").innerHTML =
        `<p style="color:red">${error}</p>`;
      console.error(error);
    });
}
</script>


</head>
<body>
  <div id="header-container"></div>
  <div id="main-container"></div>
</body>
</html>
